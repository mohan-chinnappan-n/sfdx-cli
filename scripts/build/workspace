#!/usr/bin/env bash

source ./scripts/_init

set -x

function build () {
    setarch "$ARCH"
    # Setup workspace
    rm -rf "$WORKSPACE_DIR"
    cp -r "$BASE_DIR" "$WORKSPACE_DIR"

    "$ROOT_DIR/scripts/build/fetch_node" "$WORKSPACE_DIR/bin"

    # Add bin runner and optional standalone installer
    if [[ "$OS" == "windows" ]]; then
        sed "s/REM @OVERRIDES@/set SFDX_INSTALLER=true\\&set BIN_NAME=$BIN_NAME/" \
            "$ROOT_DIR/bin/run.cmd" > "$WORKSPACE_DIR/bin/$BIN_NAME.cmd"
    else
        sed "s/# @OVERRIDES@/export SFDX_INSTALLER=\"true\" BIN_NAME=\"$BIN_NAME\"/" \
            "$ROOT_DIR/bin/run.sh" > "$WORKSPACE_DIR/bin/$BIN_NAME"
        cp "$RESOURCES_DIR/standalone/install" "$WORKSPACE_DIR"
        chmod +x "$WORKSPACE_DIR/bin/$BIN_NAME" "$RESOURCES_DIR/standalone/install"
    fi
}

for ARCH in "${ARCHS[@]}"; do
    bg build
done
wait_all
