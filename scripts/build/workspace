#!/usr/bin/env bash

source ./scripts/_init

set -x

function build () {
    setarch "$ARCH"
    # setup workspace
    rm -rf "${WORKSPACE_DIR}"
    cp -r "$BASE_DIR" "$WORKSPACE_DIR"

    "$ROOT_DIR/scripts/build/_fetch_node_binary" "${WORKSPACE_DIR}/bin"

    # create bin runner
    if [ "${OS}" == "windows" ]; then
        sed "s/REM @OVERRIDES@/set SFDX_BINARY=true \\& set BIN_NAME=$BIN_NAME/" \
            "$ROOT_DIR/bin/run.cmd" > "${WORKSPACE_DIR}/bin/$BIN_NAME.cmd"
    else
        sed "s/# @OVERRIDES@/export SFDX_BINARY=\"true\" BIN_NAME=\"$BIN_NAME\"/" \
            "$ROOT_DIR/bin/run" > "${WORKSPACE_DIR}/bin/$BIN_NAME"
        chmod +x "${WORKSPACE_DIR}/bin/$BIN_NAME"
    fi
}

for ARCH in "${ARCHS[@]}"; do
    bg build
done
wait_all
