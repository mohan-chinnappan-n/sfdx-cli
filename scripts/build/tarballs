#!/usr/bin/env bash

# creates tarballs from the workspace into dist

source ./scripts/_init

set -ex

# create tarballs
cd "$RELEASE_DIR"

function build () {
    # must be a directory in this format
    # but it is difficult to work with the version number in other places
    mv "$WORKSPACE_DIR" "$VERSIONED_BASE"

    tar c "$VERSIONED_BASE" | xz > "$TXZ_PATH" &
    local xzpid=$!
    tar czf "$TGZ_PATH" "$VERSIONED_BASE"
    wait $xzpid || exit 1
    cp "$TGZ_PATH" "$VERSIONED_BASE.tar.gz"
    cp "$TXZ_PATH" "$VERSIONED_BASE.tar.xz"

    mv "$VERSIONED_BASE" "$WORKSPACE_DIR"

    sha256=$(sha "$TGZ_PATH")
    sha256xz=$(sha "$TXZ_PATH")
    cat << EOF > "$RELEASE_DIR/${OS}-${ARCH}"
{
    "channel": "${CHANNEL}",
    "version": "${VERSION}",
    "sha256gz": "${sha256}",
    "sha256xz": "${sha256xz}"
}
EOF
    cp "$RELEASE_DIR/${OS}-${ARCH}" "$RELEASE_VERSION_DIR/${OS}-${ARCH}"
}

for ARCH in "${ARCHS[@]}"; do
    setarch "$ARCH"
    bg build
done
wait_all
