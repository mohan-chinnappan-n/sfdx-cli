#!/usr/bin/env bash

export OS=darwin
export ARCH=x64

source ./scripts/_init

set -ex

env

PKG_DIR="$WORKSPACE_DIR/installer"
mkdir -p "$PKG_DIR"

# TODO: can/should we move signing to post-productbuild?
# TODO: we may need to use another method of providing the key so we can use the jenkins cred store
extra_args=()
if [[ ! -z "${OSX_KEYCHAIN:-}" ]]; then
    extra_args+=(
        "--sign" "Developer ID Installer: Salesforce.com"
        "--keychain" "$OSX_KEYCHAIN"
    )
fi

IDENTIFIER="com.salesforce.developer.cli"

pkgbuild --root "$WORKSPACE_DIR" \
    --identifier "$IDENTIFIER" \
    --install-location "/usr/local/lib/$BIN_NAME" \
    --version "$VERSION" \
    --scripts "$RESOURCES_DIR/darwin/scripts" \
    ${extra_args[@]+${extra_args[@]}} \
    "$PKG_DIR/$PKG_NAME.pkg"

sed "s/IDENTIFIER/$IDENTIFIER/g" "$RESOURCES_DIR/darwin/distribution.xml" |
    sed "s/PKG_NAME/$PKG_NAME/g" |
    sed "s/PKG_DESC/$PKG_DESC/g" |
    sed "s/VERSION/$SHORT_VERSION/g" > "$TMP_DIR/$OS-$ARCH-distribution.xml"

productbuild --distribution "$TMP_DIR/$OS-$ARCH-distribution.xml" \
    --package-path "$PKG_DIR" \
    "$RELEASE_DIR/$PKG_NAME.pkg"

cp "$RELEASE_DIR/$PKG_NAME.pkg" "$RELEASE_DIR/$INSTALLER_BASE_NAME.pkg"
