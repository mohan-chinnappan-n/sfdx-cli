#!/usr/bin/env bash

# shellcheck disable=SC2034

source ./scripts/_init

DEFAULT_S3_BUCKET=$(node -p "require('$ROOT_DIR/package.json')['cli-engine'].s3.bucket")
S3_BUCKET="${S3_BUCKET:-"$DEFAULT_S3_BUCKET"}"
DEFAULT_S3_FOLDER=$(node -p "require('$ROOT_DIR/package.json')['cli-engine'].s3.folder")
S3_FOLDER="${S3_FOLDER:-"$DEFAULT_S3_FOLDER"}"
S3_BASE_URL="s3://$S3_BUCKET/$S3_FOLDER/$PKG_NAME/channels/$CHANNEL"

function s3upload () {
    maxage="$1"; shift
    local="$1";  shift
    remote="$1"; shift

    # Only allow uploads from the build tmp dir
    if [[ "$local" != "$TMP_DIR"* ]]; then
        stderr "Unexpected upload request from local dir: '$local'"
        exit 1
    fi

    # Only allow uploads to the target s3 bucket
    if [[ "$remote" != "$S3_BASE_URL"* ]]; then
        stderr "Unexpected upload request to s3 url: '$remote'"
        exit 1
    fi

    extra_args=()
    if [[ ! -z "${S3_ENDPOINT_URL:-}" ]]; then
        extra_args+=("--endpoint-url" "$S3_ENDPOINT_URL")
    fi

    if [[ "${DEBUG_S3_UPLOAD:-}" == "true" ]]; then
        echo "[SKIP] S3 upload from '$local' to '$remote'..."
        find "$local"
        return 0
    fi

    aws s3 cp "${extra_args[@]+"${extra_args[@]}"}" --cache-control max-age="$maxage" "$local" "$remote" "$@"
}
