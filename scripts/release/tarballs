#!/usr/bin/env bash

set -ex

source ./scripts/release/_init

resetS3CacheDir
cd "$S3_CACHE_DIR"

# Upload versioned tarballs
for OS in "${OS_TARGETS[@]}"; do
    setos "$OS"
    IFS='|' read -ra ARCHS <<< "$(archs)"
    for ARCH in "${ARCHS[@]}"; do
        setarch "$ARCH"
        cp "$TGZ_PATH" "$VERSIONED_BASE.tar.gz"
        cp "$TXZ_PATH" "$VERSIONED_BASE.tar.xz"
    done
done

s3upload "$VERSIONED_CACHE_CONTROL" \
    "$S3_CACHE_DIR" \
    "$S3_CHANNEL_UPLOAD_URL" \
    --recursive

# Upload unversioned tarballs
for OS in "${OS_TARGETS[@]}"; do
    setos "$OS"
    IFS='|' read -ra ARCHS <<< "$(archs)"
    for ARCH in "${ARCHS[@]}"; do
        setarch "$ARCH"
        mv "$VERSIONED_BASE.tar.gz" "$UNVERSIONED_BASE.tar.gz"
        mv "$VERSIONED_BASE.tar.xz" "$UNVERSIONED_BASE.tar.xz"
    done
done

s3upload "$UNVERSIONED_CACHE_CONTROL" \
    "$S3_CACHE_DIR" \
    "$S3_CHANNEL_UPLOAD_URL" \
    --recursive

rm -rf "${S3_CACHE_DIR:?}"/*

# Now upload json files
for OS in "${OS_TARGETS[@]}"; do
    setos "$OS"
    IFS='|' read -ra ARCHS <<< "$(archs)"
    for ARCH in "${ARCHS[@]}"; do
        setarch "$ARCH"
        cp "$RELEASE_DIR/${OS}-${ARCH}" "$S3_CACHE_DIR"
    done
done

cp "$RELEASE_DIR/version" "$RELEASE_VERSION_DIR/version"
cp "$RELEASE_DIR/version" "$S3_CACHE_DIR/version"
cp -r "$RELEASE_VERSION_DIR" "$S3_CACHE_DIR"

s3upload "$LATEST_VERSION_CACHE_CONTROL" \
    "$S3_CACHE_DIR" \
    "$S3_CHANNEL_UPLOAD_URL" \
    --recursive \
    --content-type "application/json"
