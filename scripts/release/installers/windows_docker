#!/usr/bin/env bash

set -ex

source ./scripts/release/_init

extra_args=()
if [[ "$USER" == "jenkins" ]]; then
    extra_args+=(
        "-v" "/etc/passwd:/etc/passwd"
        "-v" "/etc/group:/etc/group"
        "-v" "$HOME:$HOME"
        "-w" "$ROOT_DIR"
        "-u" "$(id -u):$(id -g)"
        "-e" "HOME=$HOME"
    )
else
    extra_args+=(
        "-v" "$ROOT_DIR:/home/sfdx"
        "-w" "/home/sfdx"
    )
fi

export HTTP_PROXY="$OPS_HTTP_PROXY"
export HTTPS_PROXY="$OPS_HTTPS_PROXY"

docker run \
    ${extra_args[@]+${extra_args[@]}} \
    --rm \
    -e CHANNEL \
    -e DISABLE_YARNCLEAN \
    -e FORCE_BUILD \
    -e http_proxy \
    -e HTTP_PROXY \
    -e https_proxy \
    -e HTTPS_PROXY \
    -e NO_PROXY \
    -e NPM_REGISTRY \
    -e PARALLEL_OS_BUILDS \
    -e S3_ACCESS_KEY \
    -e S3_SECRET \
    -e S3_ENDPOINT \
    -e S3_BUCKET \
    -e S3_REGION \
    -e SKIP_AWS \
    -e WINDOWS_SIGNING_KEY \
    -e WINDOWS_SIGNING_PASS \
    --entrypoint scripts/release/installers/windows \
    dickeyxxx/cli-engine-docker-nsis:v3.0.3
