#!/usr/bin/env bash
set -e

# @OVERRIDES@
# If autoupdate is not explicitly set for local dev or npm modes, make sure they are disabled.
if [[ "${SFDX_BINARY:-}" != "true" && -z "${SFDX_AUTOUPDATE_DISABLE+x}" ]]; then
    export SFDX_AUTOUPDATE_DISABLE="true"
    # This only applies to npm updates, but shouldn't hurt anything in the local dev case
    export SFDX_AUTOUPDATE_DISABLE_MESSAGE="update with 'npm install --global sfdx-cli'"
fi

DEV_FLAGS=()
NODE_FLAGS=()
CLI_ARGS=()

# Process only cli flags that must be handled before invoking node
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --dev-suspend) NODE_FLAGS+=("--inspect-brk"); DEV_FLAGS+=("$1"); shift;;
        --dev-profile) NODE_FLAGS+=("--prof");        DEV_FLAGS+=("$1"); shift;;
                    *) CLI_ARGS+=("$1");                               ; shift;;
    esac
done

get_script_dir () {
    SOURCE="${BASH_SOURCE[0]}"
    # While $SOURCE is a symlink, resolve it
    while [[ -h "$SOURCE" ]]; do
        DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
        SOURCE="$( readlink "$SOURCE" )"
        # If $SOURCE was a relative symlink (so no "/" as prefix, need to resolve it relative to the symlink base directory
        [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
    done
    DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    echo "$DIR"
}
DIR=$(get_script_dir)

# Normalize home directory
CLI_HOME=$(cd && pwd)
XDG_DATA_HOME="${XDG_DATA_HOME:="$CLI_HOME/.local/share"}"
BIN_DIR="$XDG_DATA_HOME/$BIN_NAME/client/bin"

if [[ "${SFDX_BINARY:-}" == "true" && -x "$BIN_DIR/$BIN_NAME" && ! "$BIN_DIR" -ef "$DIR" ]]; then
    "$XDG_DATA_HOME/$BIN_NAME/client/bin/$BIN_NAME" "${DEV_FLAGS[@]}" "${CLI_ARGS[@]}"
else
    CLI_BINPATH="$DIR/run" node "${NODE_FLAGS[@]}" "$DIR/run.js" "${CLI_ARGS[@]}"
fi
